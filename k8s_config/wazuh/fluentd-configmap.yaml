apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: logging
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/pods/**/*.log
      pos_file /var/log/fluentd-containers.pos
      tag kubernetes.*
      # Parse CRI logs generated by containerd
      <parse>
        @type none
      </parse>
      time_format %Y-%m-%dT%H:%M:%S.%L%z
      read_from_head true
    </source>

    # Enrich logs with Kubernetes metadata
    <filter kubernetes.**>
      @type kubernetes_metadata
      kubernetes_url https://kubernetes.default.svc:443
      verify_ssl true
      ca_file /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file /var/run/secrets/kubernetes.io/serviceaccount/token
      namespace_path /var/run/secrets/kubernetes.io/serviceaccount/namespace
    </filter>

    # Add fallback values to placeholders if metadata is unavailable
    <filter kubernetes.**>
      @type record_transformer
      <record>
        namespace ${record["kubernetes"]["namespace_name"] || "unknown"}
        pod_name ${record["kubernetes"]["pod_name"] || "unknown"}
        container_name ${record["kubernetes"]["container_name"] || "unknown"}
      </record>
    </filter>

    # Forward logs to Wazuh server
    <match kubernetes.**>
      @type forward
      <server>
        host 192.168.3.159
        port 1514
        tls false
      </server>
    </match>
